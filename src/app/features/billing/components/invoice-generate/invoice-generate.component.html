<div class="card p-4">
  <div class="flex justify-content-between align-items-center mb-4">
    <h2 class="m-0 text-primary">Generate New Invoice</h2>
    <button
      pButton
      icon="pi pi-times"
      class="p-button-text p-button-secondary"
      (click)="cancel()"
    ></button>
  </div>

  <form [formGroup]="invoiceForm">
    <!-- Patient Section -->
    <p-panel header="Patient Details" [toggleable]="true" styleClass="mb-4">
      <div class="grid p-fluid">
        <div class="col-12 md:col-6">
          <label class="block font-bold mb-2">Search Patient</label>
          <p-autoComplete
            formControlName="selectedPatient"
            [suggestions]="filteredPatients"
            (completeMethod)="searchPatients($event)"
            field="name"
            [forceSelection]="true"
            [dropdown]="true"
            (onSelect)="onPatientSelect($event)"
            placeholder="Type to search..."
            [showEmptyMessage]="true"
            emptyMessage="No patients found"
          >
            <ng-template let-patient pTemplate="item">
              <div class="flex flex-column">
                <span class="font-bold">{{ patient.name }}</span>
                <span class="text-sm text-500"
                  >ID: {{ patient.id }} | {{ patient.contact }}</span
                >
              </div>
            </ng-template>
          </p-autoComplete>
          <small class="text-secondary block mt-1">Search by name</small>
        </div>

        <div class="col-12 md:col-3">
          <label class="block font-bold mb-2">Patient ID</label>
          <input
            pInputText
            formControlName="patientId"
            readonly
            class="surface-ground"
          />
        </div>

        <div class="col-12 md:col-3">
          <label class="block font-bold mb-2">Patient Name</label>
          <input
            pInputText
            formControlName="patientName"
            readonly
            class="surface-ground"
          />
        </div>
      </div>
    </p-panel>

    <!-- Items Section -->
    <p-panel header="Invoice Items" [toggleable]="true" styleClass="mb-4">
      <div formArrayName="items">
        <p-table [value]="items.controls" styleClass="p-datatable-striped">
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 30%">Item / Service</th>
              <th style="width: 30%">Description</th>
              <th style="width: 10%">Qty</th>
              <th style="width: 15%">Unit Price</th>
              <th style="width: 10%">Total</th>
              <th style="width: 5%"></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item let-i="rowIndex">
            <tr [formGroupName]="i">
              <td>
                <p-dropdown
                  [options]="chargeItems"
                  formControlName="selectedItem"
                  optionLabel="name"
                  [filter]="true"
                  filterBy="name"
                  (onChange)="onItemSelect($event, i)"
                  placeholder="Select Item"
                  styleClass="w-full"
                  appendTo="body"
                >
                </p-dropdown>
              </td>
              <td>
                <input
                  pInputText
                  formControlName="description"
                  placeholder="Description"
                  class="w-full"
                />
              </td>
              <td>
                <p-inputNumber
                  formControlName="quantity"
                  [min]="1"
                  (onInput)="calculateRowTotal(i)"
                  styleClass="w-full"
                ></p-inputNumber>
              </td>
              <td>
                <p-inputNumber
                  formControlName="unitPrice"
                  mode="currency"
                  currency="INR"
                  locale="en-IN"
                  (onInput)="calculateRowTotal(i)"
                  styleClass="w-full"
                ></p-inputNumber>
              </td>
              <td class="font-bold text-right">
                {{
                  item.get('unitPrice').value * item.get('quantity').value
                    | currency: 'INR'
                }}
              </td>
              <td class="text-center">
                <button
                  pButton
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-danger p-button-text"
                  (click)="removeItem(i)"
                  [disabled]="items.length === 1"
                ></button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="footer">
            <tr>
              <td colspan="6">
                <button
                  pButton
                  label="Add Item"
                  icon="pi pi-plus"
                  class="p-button-text"
                  (click)="addItem()"
                ></button>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </p-panel>

    <!-- Summary & Actions -->
    <div
      class="flex justify-content-end align-items-center mb-4 p-4 surface-50 border-round"
    >
      <div class="text-right">
        <div class="text-xl mb-2">Total Amount</div>
        <div class="text-4xl font-bold text-primary">
          {{ invoiceTotal | currency: 'INR' }}
        </div>
      </div>
    </div>

    <div class="flex justify-content-end gap-2">
      <button
        pButton
        label="Cancel"
        class="p-button-outlined p-button-secondary"
        (click)="cancel()"
      ></button>
      <button
        pButton
        label="Generate Invoice"
        icon="pi pi-check"
        (click)="saveInvoice()"
        [disabled]="invoiceForm.invalid || items.length === 0"
      ></button>
    </div>
  </form>
</div>
<p-toast></p-toast>
