<app-card>
  <app-page-header
    title="Consultation"
    icon="pi pi-stethoscope"
    [showBack]="true"
  ></app-page-header>

  <!-- Patient Context -->
  <div
    class="surface-ground p-3 border-round mb-3 flex align-items-center gap-3"
  >
    <p-avatar
      icon="pi pi-user"
      size="large"
      shape="circle"
      [style]="{ background: 'var(--hms-primary)', color: 'white' }"
      styleClass="text-white"
    ></p-avatar>
    <div>
      <div class="text-xl font-bold">{{ patientName || 'Loading...' }}</div>
      <div class="text-500" *ngIf="currentEncounter">
        <span>{{ currentEncounter.patientGender }}</span> •
        <span>{{ currentEncounter.patientDob | date }}</span> •
        <span>ID: {{ currentEncounter.patientId }}</span>
      </div>
    </div>
    <div class="ml-auto">
      <button
        pButton
        label="Finish Consultation"
        icon="pi pi-check"
        class="p-button-success"
        (click)="finishConsultation()"
        [loading]="loading"
      ></button>
    </div>
  </div>

  <p-progressBar mode="indeterminate" *ngIf="loading"></p-progressBar>

  <p-tabView *ngIf="currentEncounter">
    <p-tabPanel header="Vitals (Triage)" leftIcon="pi pi-heart">
      <!-- Reusing Vitals View from Triage Module -->
      <!-- We need to pass encounterId or appointmentId. VitalsView expects appointmentId currently? -->
      <!-- Let's check VitalsViewComponent. If it expects AppointmentId, we have it. -->
      <app-vitals-view [appointmentId]="appointmentId!"></app-vitals-view>
    </p-tabPanel>

    <p-tabPanel header="Diagnosis & Notes" leftIcon="pi pi-book">
      <app-diagnosis-notes
        [(diagnosis)]="diagnosis"
        [(chiefComplaint)]="chiefComplaint"
        [(notes)]="notes"
      ></app-diagnosis-notes>
      <div class="flex justify-content-end mt-3">
        <button
          pButton
          label="Save Notes"
          icon="pi pi-save"
          (click)="saveDiagnosis()"
        ></button>
      </div>
    </p-tabPanel>

    <p-tabPanel header="Prescription" leftIcon="pi pi-file-edit">
      <!-- We might want to pass existing items if any. For now, empty or load from service -->
      <app-prescription (save)="onPrescriptionSave($event)"></app-prescription>
    </p-tabPanel>

    <p-tabPanel header="Lab Reports" leftIcon="pi pi-file">
      <div *ngIf="currentEncounter">
        <app-lab-request-list
          [encounterId]="currentEncounter.id"
        ></app-lab-request-list>
      </div>
      <div class="mt-3">
        <button
          pButton
          label="Order New Test"
          icon="pi pi-plus"
          [routerLink]="['/lab/request']"
          [queryParams]="{ encounterId: currentEncounter.id }"
        ></button>
      </div>
    </p-tabPanel>
  </p-tabView>
</app-card>
