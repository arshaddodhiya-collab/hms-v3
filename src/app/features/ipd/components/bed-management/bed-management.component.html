<app-page-header
  title="Bed Management"
  subtitle="Track bed occupancy and wards"
  icon="th-large"
></app-page-header>

<div class="px-4 pb-4 flex flex-column gap-4">
  <!-- Summary Stats -->
  <div class="grid">
    <!-- Total Beds -->
    <div class="col-12 md:col-6 lg:col-3">
      <div
        class="stat-card relative overflow-hidden surface-card border-round-2xl p-4 h-full flex flex-column justify-content-between transition-all transition-duration-300"
        style="box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05); cursor: pointer"
      >
        <!-- Gradient Accent Line -->
        <div
          class="absolute top-0 left-0 w-full"
          style="
            height: 4px;
            background: linear-gradient(
              90deg,
              var(--blue-400),
              var(--blue-600)
            );
          "
        ></div>

        <!-- Content -->
        <div class="flex justify-content-between align-items-start mt-2">
          <div>
            <span class="text-600 font-medium text-sm block mb-2"
              >Total Beds</span
            >
            <div
              class="font-bold text-3xl text-900"
              style="letter-spacing: -0.5px"
            >
              {{ beds.length }}
            </div>
          </div>
          <div
            class="flex align-items-center justify-content-center border-round-xl bg-blue-100"
            style="width: 3rem; height: 3rem"
          >
            <i class="pi pi-th-large text-xl text-blue-500"></i>
          </div>
        </div>

        <!-- Subtle Background Glow -->
        <div
          class="absolute bg-blue-500"
          style="
            width: 120px;
            height: 120px;
            border-radius: 50%;
            opacity: 0.05;
            right: -40px;
            bottom: -40px;
          "
        ></div>
      </div>
    </div>

    <!-- Available -->
    <div class="col-12 md:col-6 lg:col-3">
      <div
        class="stat-card relative overflow-hidden surface-card border-round-2xl p-4 h-full flex flex-column justify-content-between transition-all transition-duration-300"
        style="box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05); cursor: pointer"
      >
        <div
          class="absolute top-0 left-0 w-full"
          style="
            height: 4px;
            background: linear-gradient(
              90deg,
              var(--green-400),
              var(--green-600)
            );
          "
        ></div>

        <div class="flex justify-content-between align-items-start mt-2">
          <div>
            <span class="text-600 font-medium text-sm block mb-2"
              >Available</span
            >
            <div
              class="font-bold text-3xl text-900"
              style="letter-spacing: -0.5px"
            >
              {{ getAvailableCount() }}
            </div>
          </div>
          <div
            class="flex align-items-center justify-content-center border-round-xl bg-green-100"
            style="width: 3rem; height: 3rem"
          >
            <i class="pi pi-check-circle text-xl text-green-500"></i>
          </div>
        </div>

        <div
          class="absolute bg-green-500"
          style="
            width: 120px;
            height: 120px;
            border-radius: 50%;
            opacity: 0.05;
            right: -40px;
            bottom: -40px;
          "
        ></div>
      </div>
    </div>

    <!-- Occupied -->
    <div class="col-12 md:col-6 lg:col-3">
      <div
        class="stat-card relative overflow-hidden surface-card border-round-2xl p-4 h-full flex flex-column justify-content-between transition-all transition-duration-300"
        style="box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05); cursor: pointer"
      >
        <div
          class="absolute top-0 left-0 w-full"
          style="
            height: 4px;
            background: linear-gradient(90deg, var(--red-400), var(--red-600));
          "
        ></div>

        <div class="flex justify-content-between align-items-start mt-2">
          <div>
            <span class="text-600 font-medium text-sm block mb-2"
              >Occupied</span
            >
            <div
              class="font-bold text-3xl text-900"
              style="letter-spacing: -0.5px"
            >
              {{ getOccupiedCount() }}
            </div>
          </div>
          <div
            class="flex align-items-center justify-content-center border-round-xl bg-red-100"
            style="width: 3rem; height: 3rem"
          >
            <i class="pi pi-user text-xl text-red-500"></i>
          </div>
        </div>

        <div
          class="absolute bg-red-500"
          style="
            width: 120px;
            height: 120px;
            border-radius: 50%;
            opacity: 0.05;
            right: -40px;
            bottom: -40px;
          "
        ></div>
      </div>
    </div>

    <!-- Occupancy Rate -->
    <div class="col-12 md:col-6 lg:col-3">
      <div
        class="stat-card relative overflow-hidden surface-card border-round-2xl p-4 h-full flex flex-column justify-content-between transition-all transition-duration-300"
        style="box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05); cursor: pointer"
      >
        <div
          class="absolute top-0 left-0 w-full"
          style="
            height: 4px;
            background: linear-gradient(
              90deg,
              var(--purple-400),
              var(--purple-600)
            );
          "
        ></div>

        <div class="flex justify-content-between align-items-start mt-2">
          <div>
            <span class="text-600 font-medium text-sm block mb-2"
              >Occupancy Rate</span
            >
            <div
              class="font-bold text-3xl text-900"
              style="letter-spacing: -0.5px"
            >
              {{ getOccupancyRate() }}%
            </div>
            <small class="text-600" *ngIf="beds.length > 0"
              >of {{ beds.length }} total beds</small
            >
          </div>
          <div
            class="flex align-items-center justify-content-center border-round-xl bg-purple-100"
            style="width: 3rem; height: 3rem"
          >
            <i class="pi pi-chart-pie text-xl text-purple-500"></i>
          </div>
        </div>

        <div
          class="absolute bg-purple-500"
          style="
            width: 120px;
            height: 120px;
            border-radius: 50%;
            opacity: 0.05;
            right: -40px;
            bottom: -40px;
          "
        ></div>
      </div>
    </div>
  </div>

  <!-- Legend -->
  <!-- Legend / Filter -->
  <div class="flex gap-4 align-items-center justify-content-end text-sm">
    <div class="flex align-items-center gap-2">
      <p-checkbox
        [(ngModel)]="showAvailable"
        [binary]="true"
        (onChange)="groupBedsByWard()"
        inputId="cbAvailable"
      ></p-checkbox>
      <label
        for="cbAvailable"
        class="flex align-items-center gap-2 cursor-pointer"
      >
        <!-- <span
          class="w-1rem h-1rem border-round bg-green-50 border-1 border-green-200 block"
        ></span> -->
        <span class="text-gray-600">Available</span>
      </label>
    </div>
    <div class="flex align-items-center gap-2">
      <p-checkbox
        [(ngModel)]="showOccupied"
        [binary]="true"
        (onChange)="groupBedsByWard()"
        inputId="cbOccupied"
      ></p-checkbox>
      <label
        for="cbOccupied"
        class="flex align-items-center gap-2 cursor-pointer"
      >
        <!-- <span
          class="w-1rem h-1rem border-round bg-red-50 border-1 border-red-200 block"
        ></span> -->
        <span class="text-gray-600">Occupied</span>
      </label>
    </div>
  </div>

  <!-- Wards & Beds -->
  <div class="flex flex-column gap-4">
    <app-card *ngFor="let ward of wards" class="block">
      <div
        class="flex align-items-center justify-content-between mb-3 border-bottom-1 border-gray-100 pb-2"
      >
        <h3
          class="m-0 text-xl font-semibold text-gray-800 flex align-items-center gap-2"
        >
          <i class="pi pi-home text-primary opacity-70"></i>
          {{ ward.name }}
        </h3>
        <span class="p-tag p-tag-info">{{ ward.beds.length }} Beds</span>
      </div>

      <div class="grid grid-nogutter gap-3">
        <div
          *ngFor="let bed of ward.beds"
          class="col-12 sm:col-6 md:col-4 lg:col-3 xl:col-2"
        >
          <div
            class="p-3 border-round-xl border-1 surface-card hover:shadow-2 transition-all transition-duration-200 cursor-pointer h-full flex flex-column align-items-center justify-content-center text-center gap-2 relative overflow-hidden"
            [ngClass]="{
              'bg-red-50 border-red-200': bed.isOccupied,
              'bg-green-50 border-green-200': !bed.isOccupied,
            }"
            pTooltip="{{
              bed.isOccupied ? 'Occupied by Patient' : 'Available for Admission'
            }}"
            tooltipPosition="top"
          >
            <!-- Status Indicator Stripe -->
            <div
              class="absolute top-0 left-0 w-full h-1"
              [ngClass]="{
                'bg-red-500': bed.isOccupied,
                'bg-green-500': !bed.isOccupied,
              }"
            ></div>

            <div
              class="w-4rem h-4rem border-circle flex align-items-center justify-content-center mb-1"
              [ngClass]="{
                'bg-red-100': bed.isOccupied,
                'bg-green-100': !bed.isOccupied,
              }"
            >
              <i
                class="pi text-2xl"
                [ngClass]="{
                  'pi-user text-red-600': bed.isOccupied,
                  'pi-check text-green-600': !bed.isOccupied,
                }"
              ></i>
            </div>

            <div class="flex flex-column">
              <span class="text-lg font-bold text-gray-800">{{
                bed.number
              }}</span>
              <span
                class="text-xs font-medium uppercase tracking-wide"
                [ngClass]="{
                  'text-red-600': bed.isOccupied,
                  'text-green-600': !bed.isOccupied,
                }"
              >
                {{ bed.isOccupied ? 'Occupied' : 'Open' }}
              </span>

              <!-- Patient Info & Actions -->
              <div
                *ngIf="
                  bed.isOccupied && getAdmissionForBed(bed.id) as admission
                "
                class="mt-2 flex flex-column align-items-center gap-1 w-full"
                (click)="$event.stopPropagation()"
              >
                <span
                  class="text-sm font-semibold text-center text-gray-900 w-full white-space-nowrap overflow-hidden text-overflow-ellipsis"
                  pTooltip="{{ admission.patientName }}"
                  >{{ admission.patientName }}</span
                >
                <button
                  pButton
                  icon="pi pi-plus"
                  label="Round"
                  class="p-button-rounded p-button-danger p-button-outlined p-button-sm scale-90"
                  (click)="openRoundForm(bed)"
                ></button>
              </div>
            </div>
          </div>
        </div></div
    ></app-card>
  </div>
</div>

<app-round-form
  [display]="showRoundForm"
  [admissionId]="selectedAdmissionId"
  [patientName]="selectedPatientName"
  (displayChange)="showRoundForm = $event"
  (saved)="onRoundSaved()"
></app-round-form>
