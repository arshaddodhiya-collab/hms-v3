<app-page-header
  title="Bed Management"
  subtitle="Track bed occupancy and wards"
  icon="th-large"
></app-page-header>

<div class="px-4 pb-4 flex flex-column gap-4">
  <!-- Summary Stats -->
  <div class="grid">
    <div class="col-12 md:col-4">
      <div class="card mb-0 flex justify-content-between align-items-center">
        <div>
          <span class="block text-500 font-medium mb-3">Total Beds</span>
          <div class="text-900 font-medium text-xl">{{ beds.length }}</div>
        </div>
        <div
          class="flex align-items-center justify-content-center bg-blue-100 border-round"
          style="width: 2.5rem; height: 2.5rem"
        >
          <i class="pi pi-th-large text-blue-500 text-xl"></i>
        </div>
      </div>
    </div>
    <div class="col-12 md:col-4">
      <div class="card mb-0 flex justify-content-between align-items-center">
        <div>
          <span class="block text-500 font-medium mb-3">Available</span>
          <div class="text-900 font-medium text-xl">
            {{ getAvailableCount() }}
          </div>
        </div>
        <div
          class="flex align-items-center justify-content-center bg-green-100 border-round"
          style="width: 2.5rem; height: 2.5rem"
        >
          <i class="pi pi-check-circle text-green-500 text-xl"></i>
        </div>
      </div>
    </div>
    <div class="col-12 md:col-4">
      <div class="card mb-0 flex justify-content-between align-items-center">
        <div>
          <span class="block text-500 font-medium mb-3">Occupied</span>
          <div class="text-900 font-medium text-xl">
            {{ getOccupiedCount() }}
          </div>
        </div>
        <div
          class="flex align-items-center justify-content-center bg-red-100 border-round"
          style="width: 2.5rem; height: 2.5rem"
        >
          <i class="pi pi-user text-red-500 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Legend -->
  <!-- Legend / Filter -->
  <div class="flex gap-4 align-items-center justify-content-end text-sm">
    <div class="flex align-items-center gap-2">
      <p-checkbox
        [(ngModel)]="showAvailable"
        [binary]="true"
        (onChange)="groupBedsByWard()"
        inputId="cbAvailable"
      ></p-checkbox>
      <label
        for="cbAvailable"
        class="flex align-items-center gap-2 cursor-pointer"
      >
        <!-- <span
          class="w-1rem h-1rem border-round bg-green-50 border-1 border-green-200 block"
        ></span> -->
        <span class="text-gray-600">Available</span>
      </label>
    </div>
    <div class="flex align-items-center gap-2">
      <p-checkbox
        [(ngModel)]="showOccupied"
        [binary]="true"
        (onChange)="groupBedsByWard()"
        inputId="cbOccupied"
      ></p-checkbox>
      <label
        for="cbOccupied"
        class="flex align-items-center gap-2 cursor-pointer"
      >
        <!-- <span
          class="w-1rem h-1rem border-round bg-red-50 border-1 border-red-200 block"
        ></span> -->
        <span class="text-gray-600">Occupied</span>
      </label>
    </div>
  </div>

  <!-- Wards & Beds -->
  <div class="flex flex-column gap-4">
    <app-card *ngFor="let ward of wards" class="block">
      <div
        class="flex align-items-center justify-content-between mb-3 border-bottom-1 border-gray-100 pb-2"
      >
        <h3
          class="m-0 text-xl font-semibold text-gray-800 flex align-items-center gap-2"
        >
          <i class="pi pi-home text-primary opacity-70"></i>
          {{ ward.name }}
        </h3>
        <span class="p-tag p-tag-info">{{ ward.beds.length }} Beds</span>
      </div>

      <div class="grid grid-nogutter gap-3">
        <div
          *ngFor="let bed of ward.beds"
          class="col-12 sm:col-6 md:col-4 lg:col-3 xl:col-2"
        >
          <div
            class="p-3 border-round-xl border-1 surface-card hover:shadow-2 transition-all transition-duration-200 cursor-pointer h-full flex flex-column align-items-center justify-content-center text-center gap-2 relative overflow-hidden"
            [ngClass]="{
              'bg-red-50 border-red-200': bed.isOccupied,
              'bg-green-50 border-green-200': !bed.isOccupied,
            }"
            pTooltip="{{
              bed.isOccupied ? 'Occupied by Patient' : 'Available for Admission'
            }}"
            tooltipPosition="top"
          >
            <!-- Status Indicator Stripe -->
            <div
              class="absolute top-0 left-0 w-full h-1"
              [ngClass]="{
                'bg-red-500': bed.isOccupied,
                'bg-green-500': !bed.isOccupied,
              }"
            ></div>

            <div
              class="w-4rem h-4rem border-circle flex align-items-center justify-content-center mb-1"
              [ngClass]="{
                'bg-red-100': bed.isOccupied,
                'bg-green-100': !bed.isOccupied,
              }"
            >
              <i
                class="pi text-2xl"
                [ngClass]="{
                  'pi-user text-red-600': bed.isOccupied,
                  'pi-check text-green-600': !bed.isOccupied,
                }"
              ></i>
            </div>

            <div class="flex flex-column">
              <span class="text-lg font-bold text-gray-800">{{
                bed.number
              }}</span>
              <span
                class="text-xs font-medium uppercase tracking-wide"
                [ngClass]="{
                  'text-red-600': bed.isOccupied,
                  'text-green-600': !bed.isOccupied,
                }"
              >
                {{ bed.isOccupied ? 'Occupied' : 'Open' }}
              </span>

              <!-- Patient Info & Actions -->
              <div
                *ngIf="
                  bed.isOccupied && getAdmissionForBed(bed.id) as admission
                "
                class="mt-2 flex flex-column align-items-center gap-1 w-full"
                (click)="$event.stopPropagation()"
              >
                <span
                  class="text-sm font-semibold text-center text-gray-900 w-full white-space-nowrap overflow-hidden text-overflow-ellipsis"
                  pTooltip="{{ admission.patientName }}"
                  >{{ admission.patientName }}</span
                >
                <button
                  pButton
                  icon="pi pi-plus"
                  label="Round"
                  class="p-button-rounded p-button-danger p-button-outlined p-button-sm scale-90"
                  (click)="openRoundForm(bed)"
                ></button>
              </div>
            </div>
          </div>
        </div></div
    ></app-card>
  </div>
</div>

<app-round-form
  [display]="showRoundForm"
  [admissionId]="selectedAdmissionId"
  [patientName]="selectedPatientName"
  (displayChange)="showRoundForm = $event"
  (saved)="onRoundSaved()"
></app-round-form>
