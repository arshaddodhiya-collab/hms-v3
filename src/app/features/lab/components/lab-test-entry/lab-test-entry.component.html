<app-card *ngIf="request">
  <div class="flex justify-content-between align-items-center mb-4">
    <h2>Enter Test Results: {{ request.testName }}</h2>
    <p-tag [value]="request.status" severity="info"></p-tag>
  </div>

  <div class="grid mb-4">
    <div class="col-12 md:col-6">
      <label class="block font-bold mb-1">Patient</label>
      <div>{{ request.patientName }} ({{ request.patientId }})</div>
    </div>
    <div class="col-12 md:col-6">
      <label class="block font-bold mb-1">Date</label>
      <div>{{ request.createdAt | date: 'medium' }}</div>
    </div>
    <div class="col-12 md:col-6 field mt-3">
      <app-input-text
        id="testCode"
        label="Test Code"
        [(ngModel)]="test.code"
        placeholder="e.g. CBC"
      ></app-input-text>
    </div>
  </div>

  <form [formGroup]="labForm">
    <p-table [value]="resultsControls" styleClass="p-datatable-gridlines mb-4">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 25%">Parameter</th>
          <th style="width: 20%">Value</th>
          <th style="width: 15%">Unit</th>
          <th style="width: 25%">Reference Range</th>
          <th style="width: 10%">Abnormal</th>
          <th style="width: 5%"></th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-control let-i="rowIndex">
        <tr [formGroup]="control">
          <td>
            <input
              pInputText
              type="text"
              formControlName="parameter"
              aria-label="Parameter Name"
              class="w-full"
              [ngClass]="{
                'ng-invalid ng-dirty':
                  control.get('parameter')?.invalid &&
                  control.get('parameter')?.touched,
              }"
            />
          </td>
          <td>
            <input
              pInputText
              type="text"
              formControlName="value"
              aria-label="Value"
              class="w-full"
              [ngClass]="{
                'ng-invalid ng-dirty':
                  control.get('value')?.invalid &&
                  control.get('value')?.touched,
              }"
            />
          </td>
          <td>
            <input
              pInputText
              type="text"
              formControlName="unit"
              aria-label="Unit"
              class="w-full"
            />
          </td>
          <td>
            <input
              pInputText
              type="text"
              formControlName="referenceRange"
              aria-label="Reference Range"
              class="w-full"
            />
          </td>
          <td class="text-center">
            <p-checkbox
              formControlName="isAbnormal"
              [binary]="true"
              aria-label="Is Abnormal"
            ></p-checkbox>
          </td>
          <td class="text-center">
            <button
              pButton
              icon="pi pi-trash"
              class="p-button-text p-button-danger"
              aria-label="Remove Result"
              (click)="removeResultRow(i)"
            ></button>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <div class="mb-4">
      <button
        pButton
        label="Add Parameter"
        icon="pi pi-plus"
        class="p-button-outlined"
        aria-label="Add Parameter"
        (click)="addResultRow()"
      ></button>
    </div>

    <div class="field mb-4">
      <label for="notes" class="block font-bold mb-2">Technician Notes</label>
      <textarea
        id="notes"
        pInputTextarea
        formControlName="technicianNotes"
        rows="3"
        class="w-full"
      ></textarea>
    </div>

    <div class="flex justify-content-end gap-2">
      <button
        pButton
        label="Cancel"
        class="p-button-secondary"
        aria-label="Cancel"
        (click)="cancel()"
      ></button>
      <button
        pButton
        label="Save & Complete"
        icon="pi pi-check"
        aria-label="Save and Complete"
        (click)="saveResults()"
        [disabled]="labForm.invalid"
      ></button>
    </div>
  </form>
</app-card>
