<div class="card" *ngIf="request">
  <div class="flex justify-content-between align-items-center mb-4">
    <h2>Enter Test Results: {{ request.testName }}</h2>
    <p-tag [value]="request.priority" severity="info"></p-tag>
  </div>

  <div class="grid mb-4">
    <div class="col-12 md:col-4">
      <label class="block font-bold mb-1">Patient</label>
      <div>{{ request.patientName }} ({{ request.patientId }})</div>
    </div>
    <div class="col-12 md:col-4">
      <label class="block font-bold mb-1">Doctor</label>
      <div>{{ request.doctorName }}</div>
    </div>
    <div class="col-12 md:col-4">
      <label class="block font-bold mb-1">Date</label>
      <div>{{ request.requestDate | date: "medium" }}</div>
    </div>
  </div>

  <p-table [value]="results" styleClass="p-datatable-gridlines mb-4">
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 25%">Parameter</th>
        <th style="width: 20%">Value</th>
        <th style="width: 15%">Unit</th>
        <th style="width: 25%">Reference Range</th>
        <th style="width: 10%">Abnormal</th>
        <th style="width: 5%"></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-result let-i="rowIndex">
      <tr>
        <td pEditableColumn>
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input
                pInputText
                type="text"
                [(ngModel)]="result.parameter"
                required
              />
            </ng-template>
            <ng-template pTemplate="output">
              {{ result.parameter || "Click to edit" }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td pEditableColumn>
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input
                pInputText
                type="text"
                [(ngModel)]="result.value"
                required
              />
            </ng-template>
            <ng-template pTemplate="output">
              {{ result.value || "Click to edit" }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td pEditableColumn>
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input pInputText type="text" [(ngModel)]="result.unit" />
            </ng-template>
            <ng-template pTemplate="output">
              {{ result.unit || "Click to edit" }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td pEditableColumn>
          <p-cellEditor>
            <ng-template pTemplate="input">
              <input
                pInputText
                type="text"
                [(ngModel)]="result.referenceRange"
              />
            </ng-template>
            <ng-template pTemplate="output">
              {{ result.referenceRange || "Click to edit" }}
            </ng-template>
          </p-cellEditor>
        </td>
        <td class="text-center">
          <p-checkbox
            [(ngModel)]="result.isAbnormal"
            [binary]="true"
          ></p-checkbox>
        </td>
        <td class="text-center">
          <button
            pButton
            icon="pi pi-trash"
            class="p-button-text p-button-danger"
            (click)="removeResultRow(i)"
          ></button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <div class="mb-4">
    <button
      pButton
      label="Add Parameter"
      icon="pi pi-plus"
      class="p-button-outlined"
      (click)="addResultRow()"
    ></button>
  </div>

  <div class="field mb-4">
    <label for="notes" class="block font-bold mb-2">Technician Notes</label>
    <textarea
      id="notes"
      pInputTextarea
      [(ngModel)]="technicianNotes"
      rows="3"
      class="w-full"
    ></textarea>
  </div>

  <div class="flex justify-content-end gap-2">
    <button
      pButton
      label="Cancel"
      class="p-button-secondary"
      (click)="cancel()"
    ></button>
    <button
      pButton
      label="Save & Complete"
      icon="pi pi-check"
      (click)="saveResults()"
    ></button>
  </div>
</div>
